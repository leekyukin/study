# ê³µí†µìœ¼ë¡œ ë™ì¼ì„± ë³´ì¥í•˜ê¸°

### ì‹ë³„ìê°€ ê°™ì€ ê°ì²´ == ë™ì¼í•œ ê°ì²´ 
ê³ ë¡œ equalsì™€ hashCodeë¥¼ ì¬ì •ì˜í•´ì£¼ì–´ì•¼ í•œë‹¤.

ëª¨ë“  ê°ì²´ì— ì •ì˜í•´ ì£¼ëŠ”ê±´ ê¸°ì°¬ì°¨ë„ˆ..
So PrimaryKeyEntityì— êµ¬í˜„í•´ë´…ì‹œë‹¤!

```Kotlin
@MappedSuperclass
abstract class PrimaryKeyEntity : Persistable<UUID> {

    override fun equals(other: Any?): Boolean {
        if (other == null) {
            return false
        }

        if (this::class != other::class) {
            return false
        }

        return id == (obj as PrimaryKeyEntity).id
    }

    override fun hashCode() = Objects.hashCode(id)
}
```
í•˜ì§€ë§Œ ë˜ ì´ìŠˆ ë°œìƒ!!!

<hr>
<br>

## ğŸš¨ JPA í”„ë¡ì‹œ ê°ì²´ë¡œ ë™ì¼ì„± ì²´í¬ê°€ ë¶ˆê°€ëŠ¥í•œ ì´ìŠˆ

```kotlin
@Test
fun test() {
    val user = User("í™ê¸¸ë™")
    val boardInformation = BoardInformation(null, 1)
    val board = Board("ê²Œì‹œíŒ1", "ë‚´ìš©1", boardInformation, user, setOf())

    testEntityManager.persist(user)
    testEntityManager.persist(board)
    testEntityManager.flush()
    testEntityManager.clear()

    val actual = boardRepository.findById(board.id).get()

    assertTrue(user == actual.writer)
}
```
```termianl
expected: <true> but was: <false>
Expected :true
Actual   :false
```
ì˜ì†í™” ì „ì˜ user IDì™€ DBì—ì„œ ê°€ì ¸ì˜¨ ê²Œì‹œíŒì˜ user IDê°€ ë‹¤ë¥´ë‹¤! ì´ìœ ëŠ” <b>Hibernate Proxy</b> ë•Œë¬¸.

#### âš¡ï¸ Hibernate Proxy
    JPAì˜ êµ¬í˜„ì²´ì¸ HibernateëŠ” ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ì—°ê´€ê´€ê³„ ì¡°íšŒ ì‹œ ë°˜ë“œì‹œ í•„ìš”í•  ë•Œê¹Œì§€ ì¡°íšŒ ì¿¼ë¦¬ í˜¸ì¶œì„ ì§€ì—°ì‹œí‚¤ëŠ” ì§€ì—° ë¡œë”©ì„ ì§€ì›í•œë‹¤. ì—°ê´€ê´€ê³„ë¥¼ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ì–´ ì‹¤ì œ Entityê°€ ìƒì„±ë˜ê¸° ì „ê¹Œì§€ Proxy ê°ì²´ë¥¼ ë¯¸ë¦¬ ìƒì„±í•´ì„œ ë„£ì–´ë‘ì—ˆë‹¤ê°€ ì‹¤ì œ ì¡°íšŒê°€ ë˜ë©´ Entityë¥¼ Proxyì™€ êµì²´í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë™ì‘í•œë‹¤.

ë¡œê·¸ë¥¼ ì°ì–´ë³´ì
```kotlin
override fun equals(other: Any?): Boolean {
    if (other == null) {
        return false
    }

    println(this::class)   // class com.example.kotlinentitytutorial.User
    println(other::class)  // class com.example.kotlinentitytutorial.User$HibernateProxy$bl4KAli0
    println(this::class != other::class) // true

    if (this::class != other::class) {
        return false
    }

    return id == (obj as PrimaryKeyEntity).id
}
```
ì—­ì‹œ other::classëŠ” Hiberate Proxyê°ì²´ì˜€ë‹¤.
board.writerëŠ” ì§€ì—°ë¡œë”©ìœ¼ë¡œ ì•„ì§ ì¡°íšŒ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ë˜ ê²ƒì´ë‹¤.

<hr>
<br>

## ğŸ“Œ ì²«ë²ˆì§¸ í•´ê²°ë°©ë²• Eager Loading

ì¦‰ì‹œì¡°íšŒ ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ `Board` ì¡°íšŒì‹œ `HibernateProxy`ê°€ ì•„ë‹Œ ë°”ë¡œ `User`ê°ì²´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë°©ë²•ì´ ìˆë‹¤.
```kotlin
class Board {
    // ìƒëµ...

    @ManyToOne(fetch = FetchType.EAGER, optional = false)
    var writer: User = writer
        protected set
}
```
í•˜ì§€ë§Œ ì—°ê´€ê´€ê³„ë¥¼ ë§ºì€ ê°ì²´ë¥¼ ìœ„í•´ í•­ìƒ ì¡°íšŒ ì¿¼ë¦¬ê°€ ë°œìƒí•œë‹¤ë©´ ì„±ëŠ¥ìƒ ë¬¸ì œê°€ ìƒê¸´ë‹¤. (ë°ì´í„°ë² ì´ìŠ¤ ë¶€í•˜, N+1ë¬¸ì œ ë°œìƒ)

<hr>
<br>

## ğŸ“Œ equalsë¥¼ ì•„ì£¼ ì•„ë¦„ë‹µê²Œ ë‹¤ì‹œ ì •ì˜í•˜ê¸°

```kotlin
override fun equals(other: Any?): Boolean {
    if (other == null) {
        return false
    }

    if (other !is HibernateProxy && this::class != other::class) {
        return false
    }

    return id == getIdentifier(other)
}

private fun getIdentifier(obj: Any): Serializable {
    return if (obj is HibernateProxy) {
        obj.hibernateLazyInitializer.identifier
    } else {
        (obj as PrimaryKeyEntity).id
    }
}
```

ì¼ë‹¨ HibernateProxyëŠ” ì œì™¸í•˜ê³  <br>
`hibernateProxy` ê°ì²´ë©´ `obj.hibernateLazyInitializer.identifier`ë¥¼ í†µí•´ ì‹ë³„ìë¥¼ ê°€ì ¸ì˜¤ë„ë¡ í•˜ê³  <br> 
`HibernateProxy` ê°ì²´ê°€ ì•„ë‹ˆë©´ PrimaryKeyEntity.idë¥¼ ê°€ì ¸ì˜¤ë„ë¡ í•œë‹¤.