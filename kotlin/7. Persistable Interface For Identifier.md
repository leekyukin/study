# Persistable interface for identifier

## ğŸ“Œ ê·¸ë˜ì„œ ìš°ë¦¬ê°€ ìƒê°í•´ë³¸ ìµœê³ ì˜ ì‹ë³„ìëŠ”...

1. nullì„ í—ˆìš©í•´ì„  ì•ˆëœë‹¤.
2. ìƒì„± ë‹¹ì‹œì˜ ê°’ê³¼ ì˜ì†í™”í•œ í›„ì˜ ê°’ì´ ê°™ì•„ì•¼ í•œë‹¤.
3. ë°ì´í„° ë² ì´ìŠ¤ì— ìƒì„±ì— ëŒ€í•œ ì±…ì„ì„ ë– ë§¡ê²¨ì„  ì•ˆëœë‹¤.(ê°ì²´ ìƒì„± ì§í›„ ì‹ë³„ìëŠ” null ê°’ì´ ì•„ë‹ˆì–´ì•¼ í•œë‹¤)
4. ì„œë¡œ ë‹¤ë¥¸ ê°ì²´ë“¤ ì‚¬ì´ì—ì„œë„ ì¤‘ë³µì´ ì—†ì–´ì•¼ í•œë‹¤.

> ê²°ë¡ : UUIDë¡œ ì‹ë³„ìë¥¼ ì´ˆê¸°í™” í›„ ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.


```kotlin
@Entity
class Foo(
  name: String
) {
  @Id
  val id: UUID = UUID.randomUUID()

  @Column
  var name: String = name
    private set
}
@Test
fun test() {
    val foo = Foo("test")
    fooRepository.save(foo)
    fooRepository.flush()
}
```
ì•„ë˜ ì¿¼ë¦¬ë¥¼ ë³´ë©´ ì˜ ë™ì‘í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
```terminal
Hibernate: 
    select
        foo0_.id as id1_3_0_,
        foo0_.name as name2_3_0_ 
    from
        foo foo0_ 
    where
        foo0_.id=?
Hibernate: 
    insert 
    into
        foo
        (name, id) 
    values
        (?, ?)
```

ê·¸ëŸ°ë° ë¬¸ì œê°€ ë°œìƒí•œë‹¤. 
#### ğŸš¨ ì™œ ì €ì¥ë§Œ í•˜ëŠ”ë° ì¡°íšŒ ì¿¼ë¦¬ê°€ ë‚˜ê°ˆê¹Œ?

ë¬¸ì œëŠ” EntityManager.persist()ê°€ ì•„ë‹Œ EntityManager.merge()ê°€ í˜¸ì¶œëœë‹¤. ì‹ë³„ìì˜ null ì—¬ë¶€ë¡œ ì‹ ê·œ ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ê¸° ë•Œë¬¸ì— ì‹ ê·œ Entityê°€ ì•„ë‹Œ ì´ë¯¸ ìƒì„±ëë˜ Entityë¡œ ì·¨ê¸‰í•˜ê³  ìˆë‹¤. ê·¸ë˜ì„œ ì €ì¥í•˜ê¸° ì „ì— ê°™ì€ Primary Keyë¥¼ ê°€ì§„ ë°ì´í„°ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ì¿¼ë¦¬ê°€ í•œ ë²ˆ ì‹¤í–‰ë˜ê³  ì €ì¥ëœë‹¤.

#### âš¡ï¸ EntityManager.persist() (ì¿¼ë¦¬ 1ë²ˆ)
  - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì˜ì†í™” ì‹œí‚¨ë‹¤.
  - ì“°ê¸° ì§€ì—°ìœ¼ë¡œ insertëŠ” ë‚˜ì¤‘ì— í•œ ë²ˆì— ì‹¤í–‰ëœë‹¤.

#### âš¡ï¸ EntityManager.merge() (ì¿¼ë¦¬ 2ë²ˆ)
1. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥í•  ê°ì²´ê°€ ìˆëŠ”ì§€ í™•ì¸
2. DBì— ìˆëŠ”ì§€ í™•ì¸ (ì´ë•Œ select ì‹¤í–‰)
3. ìˆìœ¼ë©´ DBì—ì„œ ë“¤ê³  ì˜¨ ê°’ì— mergeí•  ê°ì²´ ë³µì‚¬í›„ ì €ì¥ (ì´ë–„ insert ì‹¤í–‰)

<hr>
<br>

## ğŸ“Œ í•´ê²°í•´ë³´ì! (Persisable êµ¬í˜„í•˜ê¸°)

ì‚¬ì‹¤ ë¬¸ì œ ì—†ì´ Entityê°€ ìƒì„±ë˜ì§€ë§Œ êµ³ì´ ì¿¼ë¦¬ë¥¼ ë‘ ë²ˆ ë‚ ë¦´ í•„ìš”ëŠ” ì—†ìë„ˆ? ê·¸ë˜ì„œ Spring Dataì—ì„œ ì´ëŸ¬í•œ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ Persistable ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•´ì¤€ë‹¤.

<br>

### âš¡ï¸ Persistable
- getId(): Entityì˜ ì‹ë³„ìë¥¼ ë°˜í™˜
- isNew(): ìƒˆë¡­ê²Œ ìƒì„±ëœ ê°ì²´ì¸ì§€ íŒë‹¨

```kotlin
@Override
public boolean isNew(T entity) {
  return entity.isNew();
}
```
Persistable ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ Entityë¥¼ ì˜ì†í™”í•˜ë©´ JpaRersistableEntityInformation.isNew()ê°€ í˜¸ì¶œë˜ë©° 
ì—¬ê¸°ì„œ Persistable.isNew()ë¥¼ í˜¸ì¶œí•œë‹¤.
<br>

### âš¡ï¸ êµ¬í˜„í•´ë³´ì!

```kotlin
@Entity
class Foo(
    name: String
) : Persistable<UUID> {
    @Id
    private val id: UUID = UUID.randomUUID()

    @Column
    var name: String = name
        protected set

    override fun getId(): UUID = id

    override fun isNew(): Boolean = true
}
```
ë³´ì‹œë‹¤ì‹œí”¼ insert ì¿¼ë¦¬ ë”± í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
```terminal
Hibernate: 
    insert 
    into
        foo
        (name, id) 
    values
        (?, ?)
```

<hr>
<br>

## ğŸ“Œ Deleteê°€ ë˜ì§€ ì•ŠëŠ” ì´ìŠˆ!
    í•˜ì§€ë§Œ ì´ë ‡ê²Œ persistableì„ êµ¬í˜„í•˜ë©´ deleteë¥¼ í˜¸ì¶œí•  ë•Œ ì‚­ì œ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤.

```kotlin
@Override
@Transactional
@SuppressWarnings("unchecked")
public void delete(T entity) {

  Assert.notNull(entity, "Entity must not be null!");

  if (entityInformation.isNew(entity)) {
    return;
  }

  Class<?> type = ProxyUtils.getUserClass(entity);

  T existing = (T) em.find(type, entityInformation.getId(entity));

  // if the entity to be deleted doesn't exist, delete is a NOOP
  if (existing == null) {
    return;
  }

  em.remove(em.contains(entity) ? entity : em.merge(entity));
}
```

```kotlin
@Test
fun test() {
    val foo = Foo("test")
    fooRepository.save(foo)
    fooRepository.flush()

    fooRepository.delete(foo)
    fooRepository.flush()
}
```
ìœ„ ì½”ë“œëŠ” SimpleJpaRepository.delete()ë‹¤.
- entityInformation.isNew()ê°€
  - ê±°ì§“ì´ë©´(ì´ë¯¸ ìˆë˜ Entityë¼ë©´): EntityManager.remove() í˜¸ì¶œí•œë‹¤.
  - ì°¸ì´ë©´(ìƒˆë¡­ê²Œ ìƒì„±ëœ Entityë¼ë©´): ì§„í–‰í•˜ì§€ ì•Šê³  ë„˜ì–´ê°„ë‹¤.
```terminal
Hibernate: 
    insert 
    into
        foo
        (name, id) 
    values
        (?, ?)
```
insert ì¿¼ë¦¬ë§Œ ë‚˜ê°„ë‹¤. ì´ìœ ëŠ” ë‹¹ê·¼ entityInformation.isNew()ê°€ ê³ ì •ì ìœ¼ë¡œ trueë¡œ ë°˜í™˜ë˜ê¸° ë•Œë¬¸ì´ë‹¤.

<hr>
<br>

## ğŸ“Œ deleteê°€ ë˜ì§€ ì•ŠëŠ” ì´ìŠˆ í•´ê²°í•˜ê¸°

#### ì—¬ê¸°ì„œ í™œìš©í•  JPA ìˆ˜ëª…ì£¼ê¸° ì´ë²¤íŠ¸ì— ëŒ€í•œ ì½œë°± ë°©ë²•ì„ ì •ì˜í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜
- @PostPersist: ì˜ì†í™” ì´í›„ì— í•¨ìˆ˜ê°€ ì‹¤í–‰ë¨
- @PostLoad: ì˜ì†í™”í•œ ë°ì´í„°ë¥¼ ì¡°íšŒí•œ ì´í›„ì— í•¨ìˆ˜ê°€ ì‹¤í–‰ë¨

```kotlin
@Entity
class Foo(
    name: String
) : Persistable<UUID> {
    @Id
    private val id: UUID = UUID.randomUUID()

    @Column
    var name: String = name
        protected set

    override fun getId(): UUID = id

    @Transient
    private var _isNew = true

    override fun isNew(): Boolean = _isNew

    @PostPersist
    @PostLoad
    protected fun load() {
        _isNew = false
    }
}
```
isNewì˜ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” _isNewëŠ” ì˜ì†í™”ëŠ” í•˜ì§€ ì•Šë„ë¡ @Transientë¥¼ ì„ ì–¸í•´ì¤€ë‹¤. <br>
ë¡œê·¸ë¥¼ ë³´ë©´ delete ì¿¼ë¦¬ê°€ ì‹¤í–‰ëœë‹¤. ğŸ‘ğŸ¿
* @Transient: ë””ë¹„ ì»¬ëŸ¼ê³¼ í•´ë‹¹ ë°ì´í„°ë¥¼ ë§¤í•‘ ì‹œí‚¤ì§€ ì•ŠìŒ


```terminal
Hibernate: 
    insert 
    into
        foo
        (name, id) 
    values
        (?, ?)
Hibernate: 
    delete 
    from
        foo 
    where
        id=?
```

Persistable êµ¬í˜„ì‹œ ì—¬ëŸ¬ ì´ìŠˆê°€ ë°œìƒí•˜ê¸°ì— ì£¼ì˜í•˜ì…ˆ!!